<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mounjaro® Dosing Steady-State Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .disclaimer {
            border-left: 4px solid #f59e0b; /* amber-500 */
            background-color: #fffbeb; /* amber-50 */
            color: #b45309; /* amber-700 */
        }
        /* Custom slider styles */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e5e7eb; /* gray-200 */
            border-radius: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5; /* indigo-600 */
            cursor: pointer;
            margin-top: -6px; /* Center thumb on track */
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e5e7eb;
            border-radius: 5px;
        }
        input[type=range]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Mounjaro® Dosing Steady-State Calculator</h1>
            <p class="text-gray-600 mt-2">Visualize Mounjaro® (Tirzepatide) levels over time.</p>
        </header>

        <!-- Disclaimer -->
        <div class="disclaimer p-4 rounded-md mb-8" role="alert">
            <h3 class="font-bold text-lg">Important Medical Disclaimer</h3>
            <p class="mt-1">This tool is for educational and informational purposes ONLY. It is a simplified model and does not represent real physiological processes. The results are not medical advice. <strong class="font-semibold">ALWAYS consult with a qualified healthcare professional</strong> before making any decisions about your medication or treatment plan. Do not use this tool to self-medicate or adjust your dosage.</p>
        </div>

        <!-- Main Content: Flex column on mobile, grid on desktop -->
        <div class="flex flex-col md:grid md:grid-cols-3 md:gap-8 space-y-8 md:space-y-0">
            
            <!-- Chart and Results (Order 1 on mobile) -->
            <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-lg order-1 md:order-2">
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">Steady-State Results</h2>
                    <div id="results" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-500">Peak Level</p>
                            <p id="peak-level" class="text-2xl font-bold text-green-600">- mg</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Trough Level</p>
                            <p id="trough-level" class="text-2xl font-bold text-red-600">- mg</p>
                        </div>
                        <div class="col-span-2 sm:col-span-1">
                            <p class="text-sm text-gray-500">Average Level</p>
                            <p id="average-level" class="text-2xl font-bold text-blue-600">- mg</p>
                        </div>
                    </div>
                </div>
                <div>
                    <canvas id="concentration-chart"></canvas>
                </div>
            </div>

            <!-- Controls (Order 2 on mobile) -->
            <div class="md:col-span-1 bg-white p-6 rounded-2xl shadow-lg order-2 md:order-1">
                <h2 class="text-xl font-bold mb-4 border-b pb-2">Simulation Controls</h2>
                <div id="calculator-controls" class="space-y-6">
                    <div>
                        <label for="dose-amount" class="block text-sm font-medium text-gray-700">Dose Amount: <span id="dose-amount-value" class="font-bold">2.5 mg</span></label>
                        <div class="flex items-center space-x-2 mt-2">
                            <button id="dose-dec" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">-</button>
                            <input type="range" id="dose-amount" min="1" max="15" value="2.5" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <button id="dose-inc" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">+</button>
                        </div>
                    </div>
                    <div>
                        <label for="dose-interval" class="block text-sm font-medium text-gray-700">Dosing Interval: <span id="dose-interval-value" class="font-bold">7 days</span></label>
                        <div class="flex items-center space-x-2 mt-2">
                            <button id="interval-dec" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">-</button>
                            <input type="range" id="dose-interval" min="1" max="14" value="7" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <button id="interval-inc" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">+</button>
                        </div>
                    </div>
                    <div>
                        <label for="simulation-days" class="block text-sm font-medium text-gray-700">Simulation Length (days)</label>
                        <input type="number" id="simulation-days" value="60" step="1" min="30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    </div>
                    <div class="text-xs text-gray-500 pt-2 border-t">
                        <p><strong>Model:</strong> 2-Compartment PK</p>
                        <p>Parameters based on clinical trial data for Tirzepatide.</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Explanations Section -->
        <div class="mt-8 space-y-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">How to Use This Tool</h2>
                <div class="space-y-4 text-gray-700">
                    <p>This calculator helps you visualize how different Mounjaro® dosing strategies might affect the total amount of the drug in your system over time. Simply adjust the sliders and inputs to see the chart update in real-time.</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>Dose Amount:</strong> Use the slider or the `+` and `-` buttons to set the amount (in mg) of each individual dose.</li>
                        <li><strong>Dosing Interval:</strong> Use the slider or the `+` and `-` buttons to set the number of days between each dose.</li>
                        <li><strong>Simulation Length:</strong> Set the total number of days you want the simulation to run for. A longer period (like 60-90 days) is better for seeing the drug reach a "steady state."</li>
                    </ul>
                    <p>The <strong>Steady-State Results</strong> show the peak (highest), trough (lowest), and average drug levels achieved during the last full dosing cycle of the simulation, which is when the drug levels have stabilized.</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">How the Calculation Works</h2>
                <div class="space-y-4 text-gray-700">
                    <p>This tool uses an advanced **two-compartment pharmacokinetic model** based on published clinical data for Tirzepatide (Urva, et al., 2023). The simulation runs on an hourly basis to provide a more accurate curve.</p>
                    <p>The model tracks the drug in three distinct "compartments":</p>
                    <ol class="list-decimal list-inside space-y-2">
                        <li><strong>Depot Compartment:</strong> After a subcutaneous injection, the drug sits in a "depot" under the skin.</li>
                        <li><strong>Central Compartment:</strong> The drug is gradually absorbed from the depot into the central compartment, which represents the blood plasma and highly perfused organs.</li>
                        <li><strong>Peripheral Compartment:</strong> From the blood, the drug distributes into the peripheral compartment, representing other body tissues. It can also move back from the tissues into the blood.</li>
                    </ol>
                    <p>Drug elimination (clearance) only occurs from the central (blood) compartment. This more complex model provides a more realistic simulation of drug absorption, distribution, and elimination compared to a simple half-life model.</p>
                    <h3 class="text-lg font-semibold pt-2">Key Assumptions</h3>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>Population Data:</strong> The model uses average pharmacokinetic parameters (absorption rate, clearance, compartment volumes) from the published study.</li>
                        <li><strong>No Individual Variation:</strong> The simulation does not account for individual factors like body weight, metabolism, or organ function, which can all affect drug levels in the real world.</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DOM Element References ---
        const doseAmountSlider = document.getElementById('dose-amount');
        const doseIntervalSlider = document.getElementById('dose-interval');
        const simulationDaysInput = document.getElementById('simulation-days');
        
        const doseAmountValueEl = document.getElementById('dose-amount-value');
        const doseIntervalValueEl = document.getElementById('dose-interval-value');
        
        const peakLevelEl = document.getElementById('peak-level');
        const troughLevelEl = document.getElementById('trough-level');
        const averageLevelEl = document.getElementById('average-level');

        const doseIncBtn = document.getElementById('dose-inc');
        const doseDecBtn = document.getElementById('dose-dec');
        const intervalIncBtn = document.getElementById('interval-inc');
        const intervalDecBtn = document.getElementById('interval-dec');
        
        const ctx = document.getElementById('concentration-chart').getContext('2d');
        let concentrationChart;

        // --- Main Calculation Logic ---
        function runSimulation() {
            // Get inputs from controls
            const doseAmount = parseFloat(doseAmountSlider.value);
            const doseIntervalDays = parseInt(doseIntervalSlider.value);
            const simulationDays = parseInt(simulationDaysInput.value);
            
            // --- Two-Compartment Model Parameters for Tirzepatide ---
            // Source: Urva, S., O'Farrell, C., et al. (2023). Population pharmacokinetics of the GIP/GLP‐1 receptor agonist tirzepatide.
            // CPT: Pharmacometrics & Systems Pharmacology, 12(6), 835-846. DOI: 10.1002/psp4.13099
            const ka = 0.0374; // Absorption rate constant (per hour)
            const CL = 0.0636; // Apparent clearance (L/hour)
            const Vc = 5.77;   // Apparent volume of central compartment (L)
            const Q = 0.0475;  // Apparent inter-compartmental clearance (L/hour)
            const Vp = 3.95;   // Apparent volume of peripheral compartment (L)

            // Validate inputs
            if (isNaN(doseAmount) || isNaN(doseIntervalDays) || isNaN(simulationDays) || doseAmount <= 0 || doseIntervalDays <= 0 || simulationDays <= 0) {
                return;
            }
            
            let depotMass = 0;      // mg
            let centralMass = 0;    // mg
            let peripheralMass = 0; // mg

            const totalHours = simulationDays * 24;
            const doseIntervalHours = doseIntervalDays * 24;
            
            const dailySystemMassData = [];
            const labels = [];

            // --- Hourly Simulation Loop ---
            for (let hour = 0; hour <= totalHours; hour++) {
                // On the first hour of a day, record the data for the chart
                if (hour % 24 === 0) {
                    labels.push(`Day ${hour / 24}`);
                    dailySystemMassData.push(centralMass + peripheralMass);
                }

                // Add new dose to the depot on dosing hours
                if (hour > 0 && hour % doseIntervalHours === 0) {
                    depotMass += doseAmount;
                }
                 if (hour === 0) { // First dose
                    depotMass += doseAmount;
                }

                // Calculate mass transfer for this hour
                const absorptionAmount = depotMass * ka;
                const eliminationAmount = (centralMass / Vc) * CL;
                const transferToPeripheral = (centralMass / Vc) * Q;
                const transferToCentral = (peripheralMass / Vp) * Q;

                // Update compartment masses
                depotMass -= absorptionAmount;
                centralMass += absorptionAmount - eliminationAmount - transferToPeripheral + transferToCentral;
                peripheralMass += transferToPeripheral - transferToCentral;

                // Ensure masses don't go below zero due to floating point math
                if (depotMass < 0) depotMass = 0;
                if (centralMass < 0) centralMass = 0;
                if (peripheralMass < 0) peripheralMass = 0;
            }
            
            // --- Calculate Steady-State Metrics from daily data ---
            const lastDoseDay = Math.floor((simulationDays - 1) / doseIntervalDays) * doseIntervalDays;
            
            if (lastDoseDay > doseIntervalDays) {
                const steadyStateStartIndex = lastDoseDay - doseIntervalDays;
                const lastFullCycleData = dailySystemMassData.slice(steadyStateStartIndex, lastDoseDay + 1);

                const peak = Math.max(...lastFullCycleData);
                const trough = Math.min(...lastFullCycleData);
                const average = lastFullCycleData.reduce((a, b) => a + b, 0) / lastFullCycleData.length;

                updateResults(peak, trough, average);
            } else {
                 updateResults(0, 0, 0);
            }

            updateChart(labels, dailySystemMassData);
        }

        // --- Update UI Elements ---
        function updateResults(peak, trough, average) {
            peakLevelEl.textContent = `${peak.toFixed(2)} mg`;
            troughLevelEl.textContent = `${trough.toFixed(2)} mg`;
            averageLevelEl.textContent = `${average.toFixed(2)} mg`;
        }

        function updateChart(labels, data) {
            if (concentrationChart) {
                concentrationChart.destroy();
            }
            concentrationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Drug in System (mg)',
                        data: data,
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total Drug in System (mg)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (Days)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        legend: {
                            display: false
                        }
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
        }
        
        function updateSliderLabels() {
            doseAmountValueEl.textContent = `${parseFloat(doseAmountSlider.value).toFixed(1)} mg`;
            doseIntervalValueEl.textContent = `${doseIntervalSlider.value} days`;
        }

        // --- Event Listeners and Persistence ---
        function handleSliderChange() {
            updateSliderLabels();
            // Save to session storage
            sessionStorage.setItem('mounjaroDose', doseAmountSlider.value);
            sessionStorage.setItem('mounjaroInterval', doseIntervalSlider.value);
            runSimulation();
        }
        
        function handleInputChange() {
             sessionStorage.setItem('mounjaroSimDays', simulationDaysInput.value);
             runSimulation();
        }

        doseAmountSlider.addEventListener('input', handleSliderChange);
        doseIntervalSlider.addEventListener('input', handleSliderChange);
        simulationDaysInput.addEventListener('change', handleInputChange);

        doseIncBtn.addEventListener('click', () => {
            doseAmountSlider.stepUp();
            handleSliderChange();
        });
        doseDecBtn.addEventListener('click', () => {
            doseAmountSlider.stepDown();
            handleSliderChange();
        });
        intervalIncBtn.addEventListener('click', () => {
            doseIntervalSlider.stepUp();
            handleSliderChange();
        });
        intervalDecBtn.addEventListener('click', () => {
            doseIntervalSlider.stepDown();
            handleSliderChange();
        });

        // --- Initial Setup ---
        window.onload = () => {
            // Load values from session storage if they exist
            const storedDose = sessionStorage.getItem('mounjaroDose');
            const storedInterval = sessionStorage.getItem('mounjaroInterval');
            const storedSimDays = sessionStorage.getItem('mounjaroSimDays');

            if (storedDose) {
                doseAmountSlider.value = storedDose;
            }
            if (storedInterval) {
                doseIntervalSlider.value = storedInterval;
            }
            if (storedSimDays) {
                simulationDaysInput.value = storedSimDays;
            }

            updateSliderLabels();
            runSimulation();
        };

    </script>
</body>
</html>
